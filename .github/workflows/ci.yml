name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov coverage

      - name: Run tests with coverage
        run: |
          pytest --cov=backend --cov-report=xml --cov-report=html --cov-report=term
        env:
          DB_NAME: test_db
          DB_USER: root
          DB_PASSWORD: password
          DB_HOST: 127.0.0.1
          DB_PORT: 3306

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: Display coverage summary
        run: |
          echo "ðŸ“Š COVERAGE SUMMARY:"
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          coverage = root.get('line-rate')
          if coverage:
              coverage_pct = float(coverage) * 100
              print(f'âœ… Coverage: {coverage_pct:.1f}%')
          else:
              print('âŒ Could not read coverage data')
          "

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Check Python syntax
        run: |
          echo "ðŸ” Checking Python syntax..."
          python -m py_compile backend/**/*.py || echo "âš ï¸ Some syntax issues found"

      - name: Basic code quality checks
        run: |
          echo "ðŸ“ Running basic code quality checks..."
          # VÃ©rifier que tous les fichiers Python sont valides
          find backend tests -name "*.py" -exec python -m py_compile {} \; || echo "âš ï¸ Some files have syntax issues"

          # VÃ©rifier les imports
          python -c "import sys; sys.path.append('backend'); from library.models import Book, User; from library.services import LibraryService; print('âœ… All imports successful')"

  build:
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Verify project structure
        run: |
          echo "ðŸ“ Project Structure:"
          find . -name "*.py" -path "./backend/*" -o -name "*.py" -path "./tests/*" | head -20
          echo ""
          echo "âœ… Project structure looks good!"

      - name: Create build success file
        run: |
          echo "ðŸš€ BUILD SUCCESSFUL - $(date)" > build_success.txt
          cat build_success.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build_success.txt
          retention-days: 7
