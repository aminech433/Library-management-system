name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov coverage

      - name: Run tests with coverage
        run: |
          # Cr√©er le dossier de coverage s'il n'existe pas
          mkdir -p htmlcov
          pytest --cov=backend --cov-report=xml --cov-report=html --cov-report=term
        env:
          DB_NAME: test_db
          DB_USER: root
          DB_PASSWORD: password
          DB_HOST: 127.0.0.1
          DB_PORT: 3306

      - name: Verify coverage files exist
        run: |
          echo "üîç Checking if coverage files exist..."
          ls -la coverage.xml || echo "‚ùå coverage.xml missing"
          ls -la htmlcov/ || echo "‚ùå htmlcov/ missing"

      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
          retention-days: 30

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov/
          retention-days: 30

      - name: Display coverage summary
        run: |
          echo "üìä COVERAGE SUMMARY:"
          if [ -f "coverage.xml" ]; then
            python -c "
            import xml.etree.ElementTree as ET
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = root.get('line-rate')
            if coverage:
                coverage_pct = float(coverage) * 100
                print(f'‚úÖ Coverage: {coverage_pct:.1f}%')
            else:
                print('‚ùå Could not read coverage data')
            "
          else
            echo "‚ùå coverage.xml not found"
          fi

  sonarqube:
    needs: test
    runs-on: ubuntu-latest
    if: always() # Toujours s'ex√©cuter, m√™me si test √©choue

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage XML
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml
          path: ./

      - name: Verify downloaded coverage file
        run: |
          echo "üîç Verifying downloaded coverage.xml..."
          if [ -f "coverage.xml" ]; then
            echo "‚úÖ coverage.xml downloaded successfully"
            ls -la coverage.xml
          else
            echo "‚ùå coverage.xml still missing after download"
            # Cr√©er un coverage.xml vide pour √©viter l'erreur
            echo '<?xml version="1.0" ?><coverage line-rate="0.0"></coverage>' > coverage.xml
            echo "‚ö†Ô∏è Created empty coverage.xml as fallback"
          fi

      - name: SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=backend
            -Dsonar.tests=tests
            -Dsonar.coverage.exclusions=**/tests/**,**/__init__.py
            -Dsonar.qualitygate.wait=true

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Check Python syntax
        run: |
          echo "üîç Checking Python syntax..."
          find backend tests -name "*.py" -exec python -m py_compile {} \; && echo "‚úÖ All Python files compiled successfully"

      - name: Basic code quality checks
        run: |
          echo "üìù Running basic code quality checks..."
          python -c "import sys; sys.path.append('backend'); from library.models import Book, User; from library.services import LibraryService; print('‚úÖ All imports successful')"
